<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Water System Dashboard</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

<style>
body{
  font-family: 'Segoe UI', sans-serif;
  background:#e0f7fa;
  margin:0;
  padding:15px;
}
h1{
  text-align:center;
  color:#00796b;
  margin-bottom:15px;
}

/* TOP BAR */
#topbar{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-bottom:20px;
}
#topbar button{
  padding:14px;
  background:white;
  border:2px solid #00796b;
  border-radius:12px;
  color:#00796b;
  font-weight:bold;
  cursor:pointer;
}
#topbar button:hover{
  background:#00796b;
  color:white;
}

/* GRID */
.grid.two{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:20px;
  margin-bottom:25px;
}
@media(max-width:600px){
  .grid.two{ grid-template-columns:1fr; }
}

/* CARD */
.card{
  background:white;
  padding:18px;
  border-radius:14px;
  box-shadow:0 4px 10px rgba(0,0,0,.15);
}
.card h2{
  text-align:center;
  margin:0 0 10px;
  color:#004d40;
}
.data{
  text-align:center;
  margin:6px 0;
}

/* GAUGE */
.gauge{
  width:150px;
  height:150px;
  border-radius:50%;
  background:#e0e0e0;
  display:flex;
  align-items:center;
  justify-content:center;
  margin:0 auto;
  position:relative;
}
.gauge::before{
  content:"";
  width:115px;
  height:115px;
  background:white;
  border-radius:50%;
  position:absolute;
}
.gauge span{
  position:relative;
  font-size:22px;
  font-weight:bold;
}

/* INDIVIDUAL GAUGE COLORS */
#p1Gauge { color:#4caf50; }      /* Plant 1 - green */
#p2Gauge { color:#ff9800; }      /* Plant 2 - orange */
#airTempGauge { color:#f44336; } /* Air Temp - red */
#airHumGauge { color:#2196f3; }  /* Air Humidity - blue */

/* WEATHER ICON */
#weather-icon,#forecast-icon{
  width:30px;
  vertical-align:middle;
}

/* MAP MODAL */
#mapModal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  justify-content:center;
  align-items:center;
}
#mapContainer{
  background:white;
  width:90%;
  height:80%;
  border-radius:10px;
  display:flex;
  flex-direction:column;
}
#mapHeader{
  background:#00796b;
  color:white;
  padding:6px 10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
#map{ flex:1; }
#saveLocationBtn, #closeMapBtn{
  padding:10px;
  border:none;
  background:#00796b;
  color:white;
  cursor:pointer;
  margin:5px;
  border-radius:5px;
}
#closeMapBtn { background:red; }
#closeMapBtn:hover { background:darkred; }
#saveLocationBtn:hover { background:#004d40; }


/* DEVICE STATUS */
#deviceStatus{
  text-align:center;
  padding:10px;
  border-radius:10px;
  font-weight:bold;
  margin-bottom:15px;
  color:white;
}

.status.online{ background:#4caf50; }
.status.offline{ background:#f44336; }
.status.waiting{ background:#ff9800; }


</style>
</head>

<body>

<h1>Water System Dashboard</h1>


<!-- DEVICE STATUS -->
<div id="deviceStatus" class="status waiting">
  ‚ö†Ô∏è Checking device status...
</div>


<div id="topbar">
  <button id="setLocationBtn">üìç Set Location</button>
  <button id="viewHistoryBtn">üìä View History</button>
</div>

<!-- PLANTS -->
<div class="grid two">
  <div class="card">
    <h2>Plant 1 Moisture</h2>
    <div class="gauge green" id="p1Gauge"><span id="p1Text">-- %</span></div>
  </div>
  <div class="card">
    <h2>Plant 2 Moisture</h2>
    <div class="gauge orange" id="p2Gauge"><span id="p2Text">-- %</span></div>
  </div>
</div>

<!-- AIR -->
<div class="grid two">
  <div class="card">
    <h2>Air Temperature</h2>
    <div class="gauge red" id="airTempGauge"><span id="airTempText">-- ¬∞C</span></div>
  </div>
  <div class="card">
    <h2>Air Humidity</h2>
    <div class="gauge blue" id="airHumGauge"><span id="airHumText">-- %</span></div>
  </div>
</div>

<!-- WEATHER -->
<div class="grid two">
  <div class="card">
    <h2>Current Weather</h2>
    <div class="data" id="weather-temp">Temperature: -- ¬∞C</div>
    <div class="data" id="weather-hum">Humidity: -- %</div>
    <div class="data">
      <img id="weather-icon">
      <span id="weather-cond-text">Condition: --</span>
    </div>
  </div>

  <div class="card">
    <h2>Forecast (+4h)</h2>
    <div class="data" id="forecast-temp">Temperature: -- ¬∞C</div>
    <div class="data" id="forecast-hum">Humidity: -- %</div>
    <div class="data">
      <img id="forecast-icon">
      <span id="forecast-cond-text">Condition: --</span>
    </div>
  </div>
</div>

<!-- MAP -->
<div id="mapModal">
  <div id="mapContainer">
    <div id="mapHeader">
      <span>Select location</span>
      <button id="closeMapBtn">X</button>
    </div>
    <div id="map"></div>
    <button id="saveLocationBtn">Save Location</button>
  </div>
</div>


<script>









// ---------- Firebase Init ----------
const firebaseConfig = {
  apiKey: "AIzaSyDptVEqHvZqOF1deQrOpnhQI_w6Vb5n4zQ",
  authDomain: "watersystem-e444e.firebaseapp.com",
  databaseURL: "https://watersystem-e444e-default-rtdb.firebaseio.com",
  projectId: "watersystem-e444e",
  storageBucket: "watersystem-e444e.firebasestorage.app",
  messagingSenderId: "528910169669",
  appId: "1:528910169669:web:05c99d2ca2e6d8c069952c",
  measurementId: "G-H05MNY69J6"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const WEATHER_API_KEY = "86944fb558c8416b86651651262801";


let plant1Alerted = false;
let plant2Alerted = false;

// ---------- Helpers ----------
function updateElement(id, text){ const el=document.getElementById(id); if(el) el.innerText=text; }
function formatTime(date){ return date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }

// ---------- Gauge Function ----------
function setGauge(gaugeId, textId, value, max = 100, unit = "%") {
  const gauge = document.getElementById(gaugeId);
  const text  = document.getElementById(textId);
  const percent = Math.min(value / max * 100, 100);
  const deg = percent * 3.6;

  let level = "high";
  if (percent < 30) level = "low";
  else if (percent < 70) level = "medium";

  gauge.className = "gauge " + level;
  gauge.style.background =
    `conic-gradient(currentColor ${deg}deg, #e0e0e0 ${deg}deg)`;

  text.innerText = value + " " + unit;
}

// ---------- Firebase Listeners ----------
db.ref('Air').on('value', snap => {
  const d = snap.val(); 
  if(!d) return;

  // Pass air + plant data to heartbeat
  db.ref('Plant1Moisture').once('value').then(p1Snap=>{
    db.ref('Plant2Moisture').once('value').then(p2Snap=>{
      deviceHeartbeat({
        air: d,
        plant1: p1Snap.val(),
        plant2: p2Snap.val()
      });
    });
  });

  setGauge("airTempGauge","airTempText",d.temperature,50,"¬∞C");
  setGauge("airHumGauge","airHumText",d.humidity,100,"%");
});

db.ref('Plant1Moisture').on('value', snap => {
  const d = snap.val(); if(!d) return;

  db.ref('Air').once('value').then(aSnap=>{
    db.ref('Plant2Moisture').once('value').then(p2Snap=>{
      deviceHeartbeat({
        air: aSnap.val(),
        plant1: d,
        plant2: p2Snap.val()
      });
    });
  });

  setGauge("p1Gauge","p1Text",d.percent,100,"%");

if(d.percent < 30 && !plant1Alerted){
  plant1Alerted = true;

  new Notification("üå± Plant 1 Dry!", {
    body: "Moisture below 30%"
  });
}

if(d.percent >= 30){
  plant1Alerted = false;
}







});

db.ref('Plant2Moisture').on('value', snap => {
  const d = snap.val(); if(!d) return;

  db.ref('Air').once('value').then(aSnap=>{
    db.ref('Plant1Moisture').once('value').then(p1Snap=>{
      deviceHeartbeat({
        air: aSnap.val(),
        plant1: p1Snap.val(),
        plant2: d
      });
    });
  });

  setGauge("p2Gauge","p2Text",d.percent,100,"%");

  if(d.percent < 30 && !plant2Alerted){
  plant2Alerted = true;

  new Notification("üåø Plant 2 Dry!", {
    body: "Moisture below 30%"
  });
}

if(d.percent >= 30){
  plant2Alerted = false;
}

  
});

// ---------- Weather Fetch ----------
let selectedCoords = null;

async function fetchWeather(lat, lon){
  try{
    const res = await fetch(`https://api.weatherapi.com/v1/forecast.json?key=${WEATHER_API_KEY}&q=${lat},${lon}&hours=4&aqi=no`);
    const data = await res.json();
    // Current
    updateElement('weather-temp', `Temperature: ${data.current.temp_c} ¬∞C`);
    updateElement('weather-hum', `Humidity: ${data.current.humidity} %`);
    updateElement('weather-cond-text', `Condition: ${data.current.condition.text}`);
    document.getElementById('weather-icon').src="https:"+data.current.condition.icon;
    // Forecast +4h
    const now = new Date();
    const targetHour = (now.getHours()+4)%24;
    let forecastData = data.forecast.forecastday[0].hour.find(h=>new Date(h.time).getHours()===targetHour);
    if(forecastData){
      updateElement('forecast-temp', `Temperature: ${forecastData.temp_c} ¬∞C`);
      updateElement('forecast-hum', `Humidity: ${forecastData.humidity} %`);
      updateElement('forecast-cond-text', `Condition: ${forecastData.condition.text}`);
      document.getElementById('forecast-icon').src="https:"+forecastData.condition.icon;
    }
  }catch(err){ console.error("Weather fetch error:", err); }
}

// Auto-refresh every 15 mins
setInterval(()=>{ if(selectedCoords) fetchWeather(selectedCoords.lat, selectedCoords.lng); }, 15*60*1000);

// ---------- Map Modal ----------
const mapModal = document.getElementById('mapModal');
const setLocationBtn = document.getElementById('setLocationBtn');
const saveLocationBtn = document.getElementById('saveLocationBtn');
const closeMapBtn = document.getElementById('closeMapBtn');
let map, marker;

// Load saved location
db.ref('location').on('value', snapshot=>{
  const loc = snapshot.val();
  if(loc && loc.cityname){
    const coords = loc.cityname.split(',').map(Number);
    selectedCoords={lat:coords[0], lng:coords[1]};
    fetchWeather(selectedCoords.lat, selectedCoords.lng);
    if(map && marker){
      map.setView(selectedCoords, 13);
      marker.setLatLng(selectedCoords);
    }
  }
});

// Set Location button
setLocationBtn.addEventListener('click', ()=>{
  mapModal.style.display='flex';
  if(!map){
    map = L.map('map').setView([10.396098,123.980480],13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    map.on('click', e=>{
      selectedCoords=e.latlng;
      if(marker) map.removeLayer(marker);
      marker=L.marker(selectedCoords).addTo(map);
    });
  }
});

// Save Location
saveLocationBtn.addEventListener('click', ()=>{
  if(!selectedCoords) return alert("Please select a location!");
  const coordsStr=`${selectedCoords.lat.toFixed(6)},${selectedCoords.lng.toFixed(6)}`;
  db.ref('location').set({cityname:coordsStr});
  mapModal.style.display='none';
  fetchWeather(selectedCoords.lat, selectedCoords.lng);
  alert("Location saved: "+coordsStr);
});

// Close Map
closeMapBtn.addEventListener('click', ()=>mapModal.style.display='none');
mapModal.addEventListener('click', e=>{ if(e.target===mapModal) mapModal.style.display='none'; });

// ---------- View History ----------
document.getElementById('viewHistoryBtn').addEventListener('click', ()=>{
  location.href = 'history.html';
});


// ---------- Device Status Watchdog ----------
// ---------- Device Status Watchdog ----------
// ---------- Device Status Watchdog ----------
// ---------- Device Status Watchdog ----------
let lastUpdateTime = 0;
let currentState = "waiting"; // track current status
const statusEl = document.getElementById("deviceStatus");

function setStatus(type){

  // ‚≠ê prevent repeated updates
  if(type === currentState) return;

  currentState = type;

  if(type==="online"){
    statusEl.className="status online";
    statusEl.innerText="üü¢ Device Connected";
  }
  else if(type==="offline"){
    statusEl.className="status offline";
    statusEl.innerText="‚ùå Device Disconnected (No data)";
  }
  else{
    statusEl.className="status waiting";
    statusEl.innerText="‚ö†Ô∏è Checking device status...";
  }
}

// heartbeat = only when new data arrives
// heartbeat = only when new data arrives
function deviceHeartbeat(data){
  lastUpdateTime = Date.now();

  // ‚≠ê Check if all values are zero
  const isZero = 
    (!data) ||
    ((data.air?.temperature === 0 || data.air?.temperature === undefined) &&
     (data.air?.humidity === 0 || data.air?.humidity === undefined) &&
     (data.plant1?.percent === 0 || data.plant1?.percent === undefined) &&
     (data.plant2?.percent === 0 || data.plant2?.percent === undefined));

  if(isZero){
    setStatus("waiting"); // instead of online
  } else {
    setStatus("online");
  }
}


// check every 1s (smooth)
// check every 1s (smooth)
setInterval(()=>{
  if(lastUpdateTime === 0){
    setStatus("waiting");
    return;
  }

  const diff = (Date.now() - lastUpdateTime)/1000;

  if(diff > 5){
    setStatus("offline");

    // ‚≠ê Reset all gauges locally
    setGauge("p1Gauge","p1Text",0,100,"%");
    setGauge("p2Gauge","p2Text",0,100,"%");
    setGauge("airTempGauge","airTempText",0,50,"¬∞C");
    setGauge("airHumGauge","airHumText",0,100,"%");



    // ‚≠ê Reset Firebase data to 0
    db.ref('Air').set({temperature:0, humidity:0});
    db.ref('Plant1Moisture').set({percent:0});
    db.ref('Plant2Moisture').set({percent:0});
  }
},1000);

const messaging = firebase.messaging();

// register service worker
navigator.serviceWorker.register('./firebase-messaging-sw.js')
  .then(() => console.log("SW registered"));


async function initNotifications() {
  try {
    const permission = await Notification.requestPermission();
    if (permission !== "granted") return;

    const token = await messaging.getToken({
      vapidKey: "BI9HCoP2mTvQuI24ZMbEWNhPJk4xoFumvhT7qaecz1gfprTTyIjWgPZqO_Zw4jh06f1iDD3JqkHnD9uxkVxDEGE"
    });

    console.log("FCM Token:", token);

    if(token){
      await db.ref("tokens").push(token);
      console.log("Token saved to DB");
    }

  } catch (err) {
    console.error(err);
  }
}

initNotifications();

messaging.onMessage((payload) => {
  new Notification(payload.notification.title, {
    body: payload.notification.body
  });
});


</script>

</body>
</html>


